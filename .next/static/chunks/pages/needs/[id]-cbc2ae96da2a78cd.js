(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[551],{1788:(e,t,l)=>{"use strict";l.r(t),l.d(t,{default:()=>o});var n=l(7876),a=l(7328),s=l.n(a),i=l(8230),d=l.n(i),r=l(9099),c=l(4232),u=l(9367);function o(){let e=(0,r.useRouter)(),t=(0,u.useSupabaseClient)(),l=(0,u.useUser)(),{id:a}=e.query,[i,o]=(0,c.useState)(null),[p,m]=(0,c.useState)(null),[f,h]=(0,c.useState)(null),[x,_]=(0,c.useState)(!0),[b,g]=(0,c.useState)(!1),[y,w]=(0,c.useState)(null),[N,j]=(0,c.useState)(null);(0,c.useEffect)(()=>{a&&(async()=>{_(!0),w(null),j(null);let{data:e,error:n}=await t.from("needs").select("*").eq("id",a).single(),{data:s}=await t.from("fulfillment").select("*").eq("need_id",a).in("status",["accepted","proposed"]).order("created_at",{ascending:!1}).limit(1).maybeSingle(),i=null;if(null==l?void 0:l.id){let{data:e}=await t.from("fulfillment").select("*").eq("need_id",a).eq("helper_id",l.id).order("created_at",{ascending:!1}).limit(1).maybeSingle();i=null!=e?e:null}n&&w(n.message),o(e||null),m(s||null),h(i),_(!1)})()},[a,t,null==l?void 0:l.id]);let v=(0,c.useMemo)(()=>p?"accepted"===p.status?"Accepted by a helper":"fulfilled"===p.status?"Fulfilled":"Unfulfilled":"Unfulfilled",[p]),S=!!(i&&(null==l?void 0:l.id)&&i.owner_id===l.id),k=!!f&&"proposed"===f.status,q="Accepted by a helper"===v||"Fulfilled"===v,E=async()=>{if(!a)return;if(!l)return void e.push("/login?next=".concat(encodeURIComponent(e.asPath)));if(S||q||k)return;g(!0),w(null),j(null);let{error:n}=await t.from("fulfillment").insert({need_id:a,helper_id:l.id,status:"proposed"});if(g(!1),n)return void(/duplicate key|unique/i.test(n.message)?j("You’ve already offered to help. Thank you!"):w(n.message));j("Offer sent! The requester will see your proposal.");let{data:s}=await t.from("fulfillment").select("*").eq("need_id",a).eq("helper_id",l.id).order("created_at",{ascending:!1}).limit(1).maybeSingle();h(null!=s?s:null)};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s(),{children:(0,n.jsxs)("title",{children:[(null==i?void 0:i.title)||"Need"," — 4MK"]})}),(0,n.jsxs)("div",{className:"max-w-3xl mx-auto px-4 py-8",children:[(0,n.jsx)(d(),{href:"/",className:"text-sm text-purple-700",children:"← Back"}),x&&(0,n.jsx)("p",{className:"mt-4",children:"Loading…"}),y&&(0,n.jsxs)("p",{className:"mt-4 text-red-600",children:["Error: ",y]}),N&&(0,n.jsx)("p",{className:"mt-4 text-green-700",children:N}),!x&&i&&(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("h1",{className:"text-3xl font-bold text-purple-700 mb-2",children:i.title}),(0,n.jsxs)("div",{className:"text-gray-600 mb-4",children:[i.city,i.state?", ".concat(i.state):""," • ",i.category||"other"," •"," ",i.created_at?new Date(i.created_at).toLocaleString():""]}),i.description&&(0,n.jsx)("p",{className:"mb-4 whitespace-pre-wrap",children:i.description}),(0,n.jsx)("span",{className:"inline-block mb-6 px-2 py-1 rounded text-xs font-medium ".concat("Unfulfilled"===v?"bg-yellow-100 text-yellow-800":"Accepted by a helper"===v?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"),children:v}),(0,n.jsxs)("button",{type:"button",onClick:E,disabled:b||S||q||k,className:"block mb-6 px-4 py-2 rounded text-white transition\n                ".concat(b||S||q||k?"bg-gray-400 cursor-not-allowed":"bg-purple-600 hover:bg-purple-700"),"aria-disabled":b||S||q||k,children:[S&&"You own this need",!S&&q&&"Already Accepted",!S&&!q&&k&&"Offer Sent",!S&&!q&&!k&&(b?"Sending…":"I can help")]}),(i.contact_email||i.contact_phone_e164)&&(0,n.jsxs)("div",{className:"text-sm text-gray-800",children:[(0,n.jsx)("div",{className:"font-medium mb-1",children:"Contact:"}),i.contact_email&&(0,n.jsx)("div",{children:i.contact_email}),i.contact_phone_e164&&(0,n.jsx)("div",{children:function(e){let t=/^\+1(\d{10})$/.exec(e||"");if(!t)return e||"";let l=t[1];return"(".concat(l.slice(0,3),") ").concat(l.slice(3,6),"-").concat(l.slice(6))}(i.contact_phone_e164)})]})]})]})]})}},7062:(e,t,l)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/needs/[id]",function(){return l(1788)}])},7328:(e,t,l)=>{e.exports=l(9269)}},e=>{e.O(0,[636,593,792],()=>e(e.s=7062)),_N_E=e.O()}]);